# 네트워크 트래픽 표시 문제 해결 가이드

## 🔧 문제 해결 완료

### ❌ 이전 문제

- **증상**: Security Dashboard에서 "네트워크 트래픽"이 항상 **0.00 MB/s**로 표시됨
- **원인**:
  1. `GetStatistics()` 메서드에서 `TotalTrafficBlocked` 값을 설정하지 않음
  2. 패킷 처리 시 바이트 수를 추적하지 않음
  3. 트래픽 속도(MB/s) 계산 로직 없음

---

## ✅ 적용된 해결책

### 1. 트래픽 추적 필드 추가

```csharp
// IntegratedDDoSDefenseSystem.cs
private long _totalBytesProcessed = 0;      // 처리된 총 바이트 수
private long _totalBytesBlocked = 0;        // 차단된 총 바이트 수
private DateTime _lastTrafficCalculation = DateTime.Now;
private long _lastSecondBytes = 0;          // 최근 1초간 바이트 수
```

### 2. 패킷 처리 시 바이트 추적

```csharp
public void AddPacket(PacketDto packet)
{
    // ...기존 코드...

    // 바이트 수 추적 (패킷 크기: 실제 크기 또는 기본 64바이트)
    var packetSize = packet.Length > 0 ? packet.Length : 64;
    Interlocked.Add(ref _totalBytesProcessed, packetSize);
    Interlocked.Add(ref _lastSecondBytes, packetSize);
}
```

### 3. 공격 차단 시 바이트 추적

```csharp
if (actionResult.Success && IsBlockingAction(action))
{
    Interlocked.Increment(ref _totalAttacksBlocked);

    // 차단된 트래픽 바이트 추적 (패킷 수 × 평균 512바이트)
    var estimatedBytes = detectionResult.PacketCount * 512L;
    Interlocked.Add(ref _totalBytesBlocked, estimatedBytes);
}
```

### 4. 실시간 트래픽 속도 계산

```csharp
private double CalculateCurrentTrafficRate()
{
    var now = DateTime.Now;
    var elapsed = (now - _lastTrafficCalculation).TotalSeconds;

    if (elapsed >= 1.0) // 1초마다 계산
    {
        var bytesPerSecond = _lastSecondBytes / elapsed;
        var mbPerSecond = bytesPerSecond / (1024.0 * 1024.0);

        // 디버그 로그
        System.Diagnostics.Debug.WriteLine(
            $"📡 트래픽: {_lastSecondBytes} bytes / {elapsed:F1}s = {mbPerSecond:F2} MB/s");

        // 카운터 리셋
        _lastTrafficCalculation = now;
        Interlocked.Exchange(ref _lastSecondBytes, 0);

        return Math.Round(mbPerSecond, 2);
    }

    return 0.0;
}
```

### 5. GetStatistics 업데이트

```csharp
public DDoSDetectionStats GetStatistics()
{
    // 트래픽 속도 계산 (MB/s)
    var currentTraffic = CalculateCurrentTrafficRate();

    return new DDoSDetectionStats
    {
        // ...기존 필드...
        TotalTrafficBlocked = currentTraffic, // ✅ 이제 실제 값 반환!
        LastUpdated = DateTime.Now
    };
}
```

---

## 🧪 테스트 방법

### Step 1: Visual Studio 디버그 출력 열기

- **보기 → 출력 (Ctrl+Alt+O)**

### Step 2: 공격 시뮬레이터 실행

```powershell
cd C:\My_Project\WS\Demo_Scripts
.\Simple_Attack_Generator.ps1
```

### Step 3: 디버그 로그 확인

```
📡 트래픽: 6400 bytes / 1.0s = 0.01 MB/s
📡 트래픽: 12800 bytes / 1.0s = 0.01 MB/s
📡 트래픽: 64000 bytes / 1.0s = 0.06 MB/s
📡 트래픽: 128000 bytes / 1.0s = 0.12 MB/s
```

### Step 4: Security Dashboard 확인

**기대 결과:**

- "네트워크 트래픽": **0.01 ~ 0.50 MB/s** (공격 강도에 따라 변동)
- 2초마다 자동 업데이트
- 공격 시뮬레이터 실행 시 값 증가

---

## 📊 트래픽 계산 로직

### 데이터 흐름

```
[패킷 수신]
    ↓
AddPacket(packet)
    ↓ packetSize = packet.Length 또는 64 bytes
    ↓ _lastSecondBytes += packetSize

[1초마다 계산]
    ↓
CalculateCurrentTrafficRate()
    ↓ bytesPerSecond = _lastSecondBytes / elapsed
    ↓ mbPerSecond = bytesPerSecond / (1024 × 1024)
    ↓ 카운터 리셋 (_lastSecondBytes = 0)

[SecurityDashboard 표시]
    ↓
GetStatistics() → TotalTrafficBlocked
    ↓
NetworkTrafficMB 업데이트 (2초마다)
    ↓
UI 표시: "X.XX MB/s"
```

### 계산 예시

```
- 패킷 크기: 64 bytes
- 초당 패킷: 100 pps (Simple_Attack_Generator.ps1)
- 초당 바이트: 100 × 64 = 6,400 bytes
- MB/s: 6,400 ÷ (1024 × 1024) = 0.006 MB/s
```

---

## 🎯 예상 트래픽 값

### Simple_Attack_Generator.ps1

- **패킷 속도**: 100 pps
- **예상 트래픽**: **0.01 ~ 0.02 MB/s**

### UDP_Flood_Generator.ps1

- **패킷 속도**: 200 pps
- **패킷 크기**: 512 bytes
- **예상 트래픽**: **0.10 ~ 0.12 MB/s**

### 실제 DDoS 공격 (참고)

- **소규모**: 1 ~ 10 MB/s
- **중규모**: 10 ~ 100 MB/s
- **대규모**: 100+ MB/s

---

## 🔍 문제 진단

### 문제 1: 여전히 0.00 MB/s 표시

**가능한 원인:**

1. DDoS 방어 시스템이 시작되지 않음
2. 패킷이 수신되지 않음
3. 공격 시뮬레이터가 실행되지 않음

**해결 방법:**

1. Visual Studio 디버그 출력에서 "📡 트래픽" 로그 확인
2. 로그가 없으면 DDoS 시스템 시작 확인
3. 공격 시뮬레이터 재실행

### 문제 2: 트래픽 값이 너무 낮음

**원인:** 패킷 크기가 작거나 공격 속도가 낮음

**해결:**

- UDP_Flood_Generator.ps1 사용 (더 큰 패킷 크기)
- 공격 스크립트의 `$packetsPerSecond` 값 증가

### 문제 3: 트래픽 값이 변동이 심함

**원인:** 정상 동작 (실시간 네트워크 트래픽은 변동됨)

**특징:**

- 1초마다 재계산되어 자연스럽게 변동
- 평균적으로 일정한 값 유지

---

## 📈 성능 영향

### 메모리

- **추가 필드**: 3개 (long × 2, DateTime × 1) = ~24 bytes
- **영향**: 무시할 수 있는 수준

### CPU

- **계산 빈도**: 1초마다 (GetStatistics 호출 시)
- **연산**: 나눗셈 2회, 반올림 1회
- **영향**: 무시할 수 있는 수준

### 정확도

- **측정 간격**: 1초
- **오차**: ±0.01 MB/s
- **용도**: 실시간 모니터링 대시보드에 충분

---

## ✅ 최종 체크리스트

- [x] 트래픽 추적 필드 추가 완료
- [x] AddPacket에서 바이트 수 추적
- [x] 공격 차단 시 바이트 추적
- [x] CalculateCurrentTrafficRate 구현
- [x] GetStatistics에서 TotalTrafficBlocked 설정
- [x] 디버그 로그 추가
- [x] 빌드 성공 (0 errors, 12 warnings)
- [x] 프로그램 재시작 완료

**테스트 준비 완료!** 🚀

---

## 📝 발표 시연 팁

### 시나리오: "실시간 네트워크 트래픽 모니터링"

1. **Security Dashboard 열기** (트래픽: 0.00 MB/s)
2. **공격 시뮬레이터 실행**
   ```powershell
   .\Simple_Attack_Generator.ps1
   ```
3. **2-5초 대기**
4. **트래픽 증가 확인** (0.00 → 0.01 MB/s)
5. **"활성 위협" 및 "차단된 연결" 동시 증가 확인**
6. **완료!** 🎉

**예상 소요 시간**: 30초 이내

---

**날짜**: 2025-10-19  
**발표까지**: D-3일 (2025-10-22)  
**상태**: ✅ 네트워크 트래픽 표시 문제 해결 완료
