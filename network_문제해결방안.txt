# 네트워크 패킷 캡처 문제 해결 방안

## 1. 문제 발생 원인

### 1.1 캡처 인터페이스 선택 문제
- 현재 코드는 devices[0]만 사용하여 첫 번째 인터페이스만 캡처
- 실제 트래픽이 발생하는 인터페이스가 아닐 수 있음
- Loopback, Bluetooth, 가상 어댑터 등이 선택될 수 있음

### 1.2 패킷 필터링/권한 문제
- 방화벽이나 백신 프로그램이 패킷 캡처를 차단할 수 있음
- Npcap 설치 옵션 설정이 부적절할 수 있음
  * WinPcap API-compatible Mode 미체크
  * Support loopback traffic 옵션 미체크

### 1.3 실제 트래픽 부재
- 캡처 중인 5초 동안 네트워크 트래픽이 없을 수 있음
- 테스트용 트래픽이 발생하지 않았을 수 있음

### 1.4 코드상 문제
- IP 패킷이 아닌 경우(ARP, IPv6 등) 무시됨
- UI 스레드로의 이벤트 전달 문제 발생 가능

## 2. 해결 방안

### 2.1 인터페이스 확인 및 선택
```csharp
// 인터페이스 목록 확인 코드
var devices = CaptureDeviceList.Instance;
string msg = "";
for (int i = 0; i < devices.Count; i++)
{
    msg += $"{i}: {devices[i].Description}\n";
}
MessageBox.Show(msg, "네트워크 인터페이스 목록");
```

### 2.2 Npcap 설치 확인사항
1. 관리자 권한으로 설치
2. 다음 옵션 체크 확인
   - "Support loopback traffic"
   - "Install Npcap in WinPcap API-compatible Mode"

### 2.3 테스트 방법
1. 캡처 시작 후 다음 작업 수행
   - 웹사이트 접속
   - 파일 다운로드
   - ping 명령어 실행
   - 기타 네트워크 트래픽 발생

### 2.4 코드 개선 방안
1. 인터페이스 선택 UI 추가
2. 예외 처리 강화
```csharp
try
{
    // 패킷 캡처 코드
}
catch (Exception ex)
{
    MessageBox.Show($"패킷 캡처 중 오류: {ex.Message}");
}
```

## 3. 추가 확인사항

### 3.1 시스템 요구사항
- Windows 10 이상
- 관리자 권한으로 실행
- Npcap 최신 버전 설치

### 3.2 방화벽 설정
- Windows 방화벽에서 Npcap 관련 규칙 확인
- 백신 프로그램의 네트워크 모니터링 기능 확인

### 3.3 네트워크 상태
- 네트워크 연결 상태 확인
- 실제 트래픽 발생 여부 확인
- 인터페이스 활성화 상태 확인

## 4. 문제 해결 순서

1. Npcap 재설치 (옵션 체크 확인)
2. 인터페이스 목록 확인
3. 트래픽 발생 테스트
4. 방화벽/백신 설정 확인
5. 코드 수정 및 테스트

## 5. 참고사항
- 패킷 캡처는 시스템 리소스를 많이 사용할 수 있음
- 캡처 시간을 적절히 조절할 필요가 있음
- 필요한 패킷만 필터링하여 캡처하는 것이 좋음 