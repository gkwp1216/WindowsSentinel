# 상시 네트워크 모니터링 기능 구현 계획

## 요약(Executive Summary)

- 목표: Windows Sentinel에 항상 켜진 네트워크 모니터링을 도입하여 실시간 수집/분석/표시 및 중요 이벤트 알림/저장을 제공
- 핵심 구성: SharpPcap 캡처 → PacketDotNet 파서 → 프로세스 매핑 → 실시간 분석 → UI/알림, SQLite 저장(배치)
- 성능/안정성: 일반 사용 시 CPU 2~5% 이내, 메모리 ≤ 150MB, NIC 변경/절전 복귀 시 5초 내 자동 복구, 크래시 0 목표
- 보안/개인정보: 관리자 권한 가이드, 민감 정보 마스킹 옵션, 옵트아웃 제공
- 저장/보존: 최근 N시간 또는 최대 M레코드 롤링 삭제 정책, 인덱스 최적화
- 폴백: Npcap 미설치/권한 부족 시 이벤트 로그 기반 축소 모니터링

## 다음 행동 계획(1~2주)

- [ ] 요구사항/성공기준 체크리스트 확정(문서 2) 업데이트)
- [ ] 아키텍처 초안 작성 및 저장(`docs/monitoring-architecture.md`): 파이프라인/스레딩/백프레셔/폴백 상세
- [ ] 캡처 엔진 골격 구현: 활성 NIC 자동선택, BPF 필터, Start/Stop, 예외 자동 재시작(지수 백오프)
- [ ] NetWorks_New 연결: "캡처 시작/정지" + 실시간 패킷 카운터/상태표시 바인딩
- [ ] 스모크 테스트: 유휴/부하 CPU·메모리 측정 표 작성, 오류/예외 로깅 검증
- 담당/기간: Owner @gkwp1216, 기간 2025-09-12 ~ 2025-09-26

## 1) 개요

Windows Sentinel 내에서 네트워크 트래픽을 실시간으로 수집·분석·표시하고, 중요한 보안 이벤트는 사용자에게 알림/기록하는 상시 모니터링 기능을 제공합니다. Npcap 기반 패킷 캡처를 기본으로 하되, 권한·의존성 부족 시 이벤트 로그 기반의 축소 모니터링으로 폴백합니다.

## 2) 목표와 성공 기준(수용 기준)

- 기능 범위
  - 실시간 트래픽 수집(SharpPcap + PacketDotNet), 프로세스 매핑, 보안 분석(규칙 기반), UI 실시간 표시
  - 백그라운드 지속 모니터링(앱 최소화/트레이 아이콘, 중요 경고 토스트/풍선 알림)
  - 부팅 자동 시작(선택), Npcap 미설치/권한 부족 시 폴백 모드 제공
- 성능/안정성
  - CPU 평균 2~5% 이내(일반 사용 시), 메모리 ≤ 150MB
  - 네트워크 장치 변경/절전 복귀 시 5초 이내 자동 복구, 크래시 0
- 보안/개인정보
  - 관리자 권한 필요 시 명확한 안내, 민감 정보(UI/로그) 마스킹 옵션, 옵트아웃 제공
- 데이터 보존
  - 최근 N시간 또는 최대 M레코드 보존, 롤링 삭제 정책
- 수용 체크리스트(예)
  - [ ] Npcap 설치 X → 폴백 동작, 경고·가이드 표시
  - [ ] 1시간 모니터링 중 CPU/메모리 목표 준수
  - [ ] NIC 변경/절전 복귀 시 자동 재개 확인
  - [ ] 경고 토스트/트레이 알림 수신
  - [ ] SQLite 보존 정책 정상 작동(롤링 삭제)

## 3) 아키텍처 개요

```
PacketCapture(SharpPcap)
  → Parser(PacketDotNet)
    → Mapper(ProcessNetworkMapper: PID/Port→Process)
      → Analyzer(RealTimeSecurityAnalyzer: 규칙/임계값)
        ↘ UI(그리드/차트/알림)
        ↘ Storage(SQLite 배치 저장)

Fallback: EventLog 기반 간이 모니터링(권한/의존성 부족 시)
```

- 스레딩 모델: 백그라운드 캡처/분석 + UI Dispatcher 바인딩
- 백프레셔: 고부하 시 샘플링/큐 윈도우링, 드롭율/큐 길이 메트릭 기록

## 4) 구성요소 상세

- PacketCapture(SharpPcap)
  - 활성 NIC 자동 선택(활성/IPv4/속도 기반), BPF 필터(TCP/UDP/ICMP) 지원
  - Start/Stop, 예외 시 지수 백오프로 자동 재시작
  - 드롭 카운터/처리량 메트릭 노출
- Parser(PacketDotNet)
  - 필수 필드 파싱: Timestamp, Proto, Src/Dst IP/Port, Length, Flags
- ProcessNetworkMapper
  - PID/포트 매핑 캐시, 주기 갱신, 종료 프로세스 정리, 실패 시 재시도
- RealTimeSecurityAnalyzer
  - 규칙: 의심 포트/도메인/IP, 비정상 빈도/패턴, 대용량 전송
  - 심각도 산정(낮음/보통/높음/치명), 중복 경고 억제(해시키/디바운스)
- Storage(SQLite)
  - 비동기 배치 커밋, 인덱스/보존(롤링 삭제), 장애 복구(저널 모드)
- UI/알림(NetWorks_New)
  - 그리드/차트 라이브 업데이트, 필터(프로토콜/프로세스/시간)
  - 상태 표시(캡처중/대기), 오류/힌트, 토스트/트레이 알림(중요 경고)
- Fallback(Event Log)
  - Npcap 없음/권한 부족 시 제한된 연결 기록 조회 및 표시

## 5) 데이터 모델(초안)

- connections(id, ts, proto, src_ip, src_port, dst_ip, dst_port, length, pid, process_name, risk_level)
  - 인덱스: ts, pid, (proto, ts)
- alerts(id, ts, severity, title, description, src_ip, dst_ip, src_port, dst_port, rule_id, dedup_key)
  - 인덱스: ts, severity, dedup_key
- processes(pid, name, path, signer, last_seen)
  - 인덱스: pid, last_seen
- 보존 정책: ts 기반 N시간 초과분 롤링 삭제(배치)

## 6) 스레딩/성능 전략

- 캡처/파싱/분석은 백그라운드 스레드, UI 업데이트는 Dispatcher
- 최대 큐 길이/샘플링 비율 설정으로 과부하 방지
- UI 가상화, 차트 데이터 윈도우링(최근 N 포인트), ObservableCollection 규모 제한

## 7) 수명주기/복구

- 앱 시작 시: Npcap/권한 점검 → NIC 선택 → 캡처 시작(옵션)
- 절전/재개, NIC 변경: 자동 중단/재개 처리
- 예외: 로그 후 지수 백오프로 재시작, 반복 실패 시 가이드 표출

## 8) 설정/정책

- 기본값 예시: { 인터페이스: Auto, 프로토콜: All, 보존: 24h, 경고 임계: 중간, 알림: On }
- 사용자 설정(예)
  - capture.interface(자동/지정), capture.bpf, retention.hours, retention.maxRows,
  - alert.enabled, alert.threshold, notify.tray, notify.toast,
  - perf.maxQueue, perf.samplingRate

## 9) 보안/개인정보

- 관리자 권한 요구 시 명확한 안내, 권한 저하 시 폴백
- IP/도메인/프로세스 경로 등 선택적 마스킹, 로그 레벨 제어

## 10) 로깅/진단/헬스체크

- LogHelper: 오류/경고/정보, 캡처/분석/저장 실패 로그
- 헬스 메트릭: 드롭율, 큐 길이, 재시작 횟수, 처리량
- 사용자 친화적 메시지 + 문제해결 가이드 링크

## 11) 테스트/검증 계획

- 단위: 패킷 파싱, 규칙 평가, 보존 삭제 로직
- 통합: 샘플 pcap 재생(여러 프로토콜), 고부하 시 샘플링/백프레셔 동작
- 시나리오: 최초 실행, 부팅 자동시작, 절전/복귀, NIC 변경, Npcap 없음

## 12) 배포/운영 가이드(초안)

- 요구 사항: .NET 8, Npcap 권장, 관리자 권한(권한 저하시 폴백 안내)
- 첫 실행 마법사: Npcap 설치/권한 안내, 기본 설정
- 릴리즈 체크리스트: 성능/안정/보존/알림 확인 목록

## 13) 단계별 로드맵(스프린트 3~4주)

1. 캡처 엔진/파이프 골격(SharpPcap + DTO + UI 업데이트)
2. 프로세스 매핑/보안 분석 1차 + 알림 + 폴백
3. SQLite 저장/보존 + 성능 최적화 + 오류 복구 루틴
4. 테스트/문서/운영 가이드 + 마감 튜닝

## 14) 리스크 및 완화

- Npcap/권한 장애: 폴백/가이드 제공
- 고부하 트래픽: 샘플링/큐 윈도우/차트 윈도우
- PID/포트 매핑 실패: 캐시/재시도/부분 표시

---

본 계획은 NetWorks_New 화면 중심으로 점진 구현합니다. 필요 시 Windows Service 모드(장기 목표)로 확장 가능합니다.
